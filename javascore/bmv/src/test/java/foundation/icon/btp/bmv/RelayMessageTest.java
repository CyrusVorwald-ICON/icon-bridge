package foundation.icon.btp.bmv;

import com.iconloop.testsvc.Account;
import com.iconloop.testsvc.Score;
import com.iconloop.testsvc.ServiceManager;
import com.iconloop.testsvc.TestBase;
import foundation.icon.btp.bmv.lib.mpt.MPTException;
import foundation.icon.btp.bmv.types.BlockHeader;
import foundation.icon.btp.bmv.types.RelayMessage;
import foundation.icon.icx.KeyWallet;
import org.bouncycastle.util.encoders.Hex;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.*;

import java.io.IOException;
import java.math.BigInteger;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Base64;

@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
public class RelayMessageTest extends TestBase {

    final static String RLPn = "RLPn";
    private static final ServiceManager sm = getServiceManager();

    private static final int rootSize = 3;
    private static final int cacheSize = 10;
    private static final String sol_bmc = "0xAaFc8EeaEE8d9C8bD3262CCE3D73E56DeE3FB776";
    private static final int offset = 187;
    private static final boolean isAllowNewerWitness = true;

    private static Score bmv;
    private static KeyWallet[] accounts;
    private static String currentBMCAdd;
    private static String currentBMCNet;
    private static String prevBMCAdd;
    private static String prevBMCnet;  //also destination network

    private static String currentBMCBTPAdd;
    private static String prevBMCBTPAdd;

    private static Account[] owners;

    @BeforeAll
    public static void setup() throws Exception {
        accounts = new KeyWallet[5];
        owners = new Account[3];
        for (int i = 0; i < owners.length; i++) {
            owners[i] = sm.createAccount(100);
        }
        for (int i = 0; i < accounts.length; i++) {
            accounts[i] = KeyWallet.create();
        }
        currentBMCAdd = owners[0].getAddress().toString();
        currentBMCNet = "0x03.iconee";
        prevBMCAdd = sol_bmc;
        prevBMCnet = "0x97.bsc"; //also destination network

        currentBMCBTPAdd = "btp://" + currentBMCNet + "/" + currentBMCAdd;
        prevBMCBTPAdd = "btp://" + prevBMCnet + "/" + prevBMCAdd;

        bmv = sm.deploy(owners[0], BTPMessageVerifier.class, currentBMCAdd, prevBMCnet, offset, rootSize, cacheSize, isAllowNewerWitness);

    }

    @Test
    @Order(1)
    public void test_handleRelayMessage() throws MPTException, IOException {
        var msg = "-Q_z-QUCuQT_-QT8uQJf-QJcoPg2qIyWCWvreoVnd8oEKnAyuPcHnS-kmaSv80VUblcdoB3MTejex116q4W1Z7bM1BrTEkUblIp0E_ChQv1A1JNHlEiUgpfDI27D6myV9O7CL9sYJV5VoFNM_KQ0Ihn-xZoC0pxb7AKz5pEIhLV24oVrS5uKZDj3oDUfqWaf5RUBZud_fKzLZoewS3hSaYpf7d8CxfXUYg6YoMn77M1XWzF26HSV2pB1QkWh9jcqWxVXuksZtZZDRoxUuQEAAAAAAgAAAAAAAABAAAAAAAAAABAAAAAAAAAAAAAAAAAAARAAAAAAAAAAAAAgAAAAACAAAAAAAAAAAAAAACAAAEAAAAAAAAAAAAAACAAAAAAhAAABAAAAAAAAAAEAAAAAAAgAIAAQAAQAAAAAAAAAAAAAAAABAAAAAAAAEAAAAAIAEAAAAAAAAAAAAAAAAAAAAAAEAgAAAAAAAAAAAAAACAIAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAoAAIAAAAAAAAAAAAAAAAAAAAAAAABBAEAAAACAKEAAAAAAAAAAAAAAAAAEAAAQAAAAAAAAAAAAAAAEAAAKCALyEASRunYMZ1eeEYhY12rhh2IMBAAaEZ2V0aIhnbzEuMTYuNoVsaW51eAAAAKWw-SHTuUnO9yKOxIr8GEmXSyZ0tjYyDDGqP2oWDQG0eNPSg3amc9NPXt0BVARUgSjVep30hlzH6gmKI9Cro0oss_WeAKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIgAAAAAAAAAALh4TRvmTw6aRmwuZqU0M5KBkng-Kfj6Ib6yEzSZte93D2AAAADo1KUQAJkwiqNlxAVUvImYKvUF2F2pUlFEXV3Uqbs33SWE_ZLTAAAA6NSlEAABd2kg_wsPONeM-VwDPCGt9wRXhRFOOSp1RBeWUuCmEgAAAOjUpRAAuQId-QIaYaD4NqiMlglr63qFZ3fKBCpwMrj3B50vpJmkr_NFVG5XHaAdzE3o3sddequFtWe2zNQa0xJFG5SKdBPwoUL9QNSTR5RIlIKXwyNuw-pslfTuwi_bGCVeVaBTTPykNCIZ_sWaAtKcW-wCs-aRCIS1duKFa0ubimQ496A1H6lmn-UVAWbnf3ysy2aHsEt4UmmKX-3fAsX11GIOmKDJ--zNV1sxduh0ldqQdUJFofY3KlsVV7pLGbWWQ0aMVLkBAAAAAAIAAAAAAAAAQAAAAAAAAAAQAAAAAAAAAAAAAAAAAAEQAAAAAAAAAAAAIAAAAAAgAAAAAAAAAAAAAAAgAABAAAAAAAAAAAAAAAgAAAAAIQAAAQAAAAAAAAABAAAAAAAIACAAEAAEAAAAAAAAAAAAAAAAAQAAAAAAABAAAAACABAAAAAAAAAAAAAAAAAAAAAABAIAAAAAAAAAAAAAAAgCAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAKAACAAAAAAAAAAAAAAAAAAAAAAAAAQQBAAAAAgChAAAAAAAAAAAAAAAAABAAAEAAAAAAAAAAAAAAABAAACgbyEASRunYMZ1eeEYhY12qDYgwEABoRnZXRoiGdvMS4xNi42hWxpbnV4AAAApbD5IaAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIgAAAAAAAAAAPgA-QrpuQrm-QrjALkG5vkG47hT-FGgk_bw5g-K9FLCAz0ic75Nvilh2h2eie5916xFTUjM6GqAgICAgICAoLKFhqldgdOzJ0cE-rGgT2uTUkbRtzQOtDaUY67StGLjgICAgICAgIC5Bov5BogwuQaE-QaBAYMILti5AQAAAAACAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAACAAAAAAIAAAAAAAAAAAAAAAIAAAQAAAAAAAAAAAAAAIAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAAAABAABAAAAAAAAAAAAAAAAAEAAAAAAAAQAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAIAgAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAIAoQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA-QV2-JuUujTzxok7Ev9BFazxtHEsbieDrYP4Y6Dd8lKtG-LIm2nCsGj8N42qlSun8WPEoRYo9VpN9SOz76AAAAAAAAAAAAAAAADry9SpNKaFEOIbolsqgnE4JIpj5aAAAAAAAAAAAAAAAABxoVILu35gcrvzaCpgxz1jtpNpCqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAN4Lazp2QAAPiblLo088aJOxL_QRWs8bRxLG4ng62D-GOgjFvh5evsfVvRT3FCfR6E890DFMD3sikeWyAKyMfDuSWgAAAAAAAAAAAAAAAA68vUqTSmhRDiG6JbKoJxOCSKY-WgAAAAAAAAAAAAAAAAcaFSC7t-YHK782gqYMc9Y7aTaQqgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD5AjqUqvyO6u6NnIvTJizOPXPlbe4_t3bhoDe-NT8hbPfjNjkQH9YQxULmoMAQkXP6HB2LBNNO23wbuQIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD5idHA6Ly8weDk1NGFhMy5pY29uL2N4YTExY2M4MmIxZTcwNmE3OGE1MjUwN2Q3ODBhNzMzYTk4YWVjZjIwZgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQf5AQS4OWJ0cDovLzB4OTcuYnNjLzB4QWFGYzhFZWFFRThkOUM4YkQzMjYyQ0NFM0Q3M0U1NkRlRTNGQjc3Nrg-YnRwOi8vMHg5NTRhYTMuaWNvbi9jeGExMWNjODJiMWU3MDZhNzhhNTI1MDdkNzgwYTczM2E5OGFlY2YyMGaIVG9rZW5CU0gBuH34ewC4ePh2szB4ZWJjYmQ0YTkzNGE2ODUxMGUyMWJhMjViMmE4MjcxMzgyNDhhNjNlNQAAAAAAAAAAAKpoeDNkODAwOWQyMTYzNWRhNDllYTM5YmI3ODE0ZDEyNzhlNTBjODViOWXW1YNFVEiIDb0vwTejAACHI4byb8EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD5AfyUOryN_wyVuJgjmdrPbtW9e5SkAGj4QqBQ0iNzu4TtH57rWByRPm1F2RjAX4sdkPC-Fo8GpOaZSqAAAAAAAAAAAAAAAADry9SpNKaFEOIbolsqgnE4JIpj5bkBoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-YnRwOi8vMHg5NTRhYTMuaWNvbi9oeDNkODAwOWQyMTYzNWRhNDllYTM5YmI3ODE0ZDEyNzhlNTBjODViOWUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA29L8E3owAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACOG8m_BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0VUSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-QKi-QKfArkCm_kCmKoweEFhRmM4RWVhRUU4ZDlDOGJEMzI2MkNDRTNENzNFNTZEZUUzRkI3NzbhoDe-NT8hbPfjNjkQH9YQxULmoMAQkXP6HB2LBNNO23wbuQIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD5idHA6Ly8weDk1NGFhMy5pY29uL2N4YTExY2M4MmIxZTcwNmE3OGE1MjUwN2Q3ODBhNzMzYTk4YWVjZjIwZgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQf5AQS4OWJ0cDovLzB4OTcuYnNjLzB4QWFGYzhFZWFFRThkOUM4YkQzMjYyQ0NFM0Q3M0U1NkRlRTNGQjc3Nrg-YnRwOi8vMHg5NTRhYTMuaWNvbi9jeGExMWNjODJiMWU3MDZhNzhhNTI1MDdkNzgwYTczM2E5OGFlY2YyMGaIVG9rZW5CU0gBuH34ewC4ePh2szB4ZWJjYmQ0YTkzNGE2ODUxMGUyMWJhMjViMmE4MjcxMzgyNDhhNjNlNQAAAAAAAAAAAKpoeDNkODAwOWQyMTYzNWRhNDllYTM5YmI3ODE0ZDEyNzhlNTBjODViOWXW1YNFVEiIDb0vwTejAACHI4byb8EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACCALygbfPPl3rOzScGtYSVHgP2DU4TnLHYRmRVZvWe-Ss_3IgAoKNqmgUVl1rdazlhfj51pN1jr1imQ6vS9wcYT-k09R5DAgC5AVH5AU75AUu4PmJ0cDovLzB4OTU0YWEzLmljb24vY3hhMTFjYzgyYjFlNzA2YTc4YTUyNTA3ZDc4MGE3MzNhOThhZWNmMjBmArkBB_kBBLg5YnRwOi8vMHg5Ny5ic2MvMHhBYUZjOEVlYUVFOGQ5QzhiRDMyNjJDQ0UzRDczRTU2RGVFM0ZCNzc2uD5idHA6Ly8weDk1NGFhMy5pY29uL2N4YTExY2M4MmIxZTcwNmE3OGE1MjUwN2Q3ODBhNzMzYTk4YWVjZjIwZohUb2tlbkJTSAG4ffh7ALh4-HazMHhlYmNiZDRhOTM0YTY4NTEwZTIxYmEyNWIyYTgyNzEzODI0OGE2M2U1AAAAAAAAAAAAqmh4M2Q4MDA5ZDIxNjM1ZGE0OWVhMzliYjc4MTRkMTI3OGU1MGM4NWI5ZdbVg0VUSIgNvS_BN6MAAIcjhvJvwQAA";
        byte[] _msg = Base64.getUrlDecoder().decode(msg.trim().getBytes());
        bmv.invoke(owners[0], "handleRelayMessage", currentBMCBTPAdd, prevBMCBTPAdd, BigInteger.valueOf(1), msg);
    }

    @Test
    @Order(2)
    public void verifySignatureTest() throws MPTException, IOException {
        var headerBytes = "f9025ca09d996196750bf2c1ed51f55fc08afa68c8571cc7700fc34521a843d99a034b7ca01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d493479496c5d20b2a975c050e4220be276ace4892f4b41aa04db5fbf990816f80792ceb8054d569715f848a80a6cc1a07eed0df5e4c55e1d2a00e7b0c2d8617b29440b1be5538e335ea3234608a449be7f2627de8e92ad1e7e7a05dd941745a4e6236fe79a0b6bb2333e18c9cf4601a548e381ff8a3196dee82d0b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000020100000000000000000000000000000000000200002000000000000000200000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000283a100418401c9c38082d0c68460ed4ef6b861d883010006846765746888676f312e31352e35856c696e75780000001600553d240cc9838de0cd2c0774ba6a18019b8e00d816a611ee48afcb8df7753602277c01eedc1b26f3b8e341ec36862674c1087768bad5a319348f26107d1bed4a415701a00000000000000000000000000000000000000000000000000000000000000000880000000000000000";
        //BlockHeader.verifyValidatorSignature(Hex.decode(headerBytes));
    }

    @Test
    public void relayMessageDecode() throws IOException {
        var msg = Files.readString(Path.of("relaymessage"));
        System.out.println(msg);
        byte[] _msg = Base64.getUrlDecoder().decode(msg.trim().getBytes());
        var relayMessage = RelayMessage.fromBytes(_msg);
        var receiptProof = relayMessage.getReceiptProofs()[0];
    }
}
