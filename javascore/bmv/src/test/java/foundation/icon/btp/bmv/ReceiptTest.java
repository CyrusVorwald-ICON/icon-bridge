package foundation.icon.btp.bmv;

import foundation.icon.btp.bmv.lib.HexConverter;
import foundation.icon.btp.bmv.lib.mpt.MPTException;
import foundation.icon.btp.bmv.lib.mpt.Nibbles;
import foundation.icon.btp.bmv.lib.mpt.Trie;
import foundation.icon.btp.bmv.lib.mpt.TrieNode;
import foundation.icon.btp.bmv.types.Receipt;
import i.IInstrumentation;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import score.ByteArrayObjectWriter;
import score.Context;
import testutils.TestInstrumentation;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

public class ReceiptTest {

    @BeforeEach
    public void setup() throws Exception {
        IInstrumentation.attachedThreadInstrumentation.set(new TestInstrumentation());
    }

    @AfterEach
    public void tearDown() throws Exception {
        IInstrumentation.attachedThreadInstrumentation.remove();
    }

    /**
     * Test sample data: beb20_tx_1.json
     *
     * @throws MPTException
     */
    @Test
    public void trieFromProofsTest() throws MPTException {
       List<byte[]> encodedProof = new ArrayList<>();
       byte[] root = HexConverter.hexStringToByteArray("fd98a32d62e7d3209b79727a0af3f911137d5686f286fcea51a3d3c58596033d");
       encodedProof.add(HexConverter.hexStringToByteArray("f851a0b901a268ad64e9356dd317dcaade0ba6052bf7afcede80a83efda3362f01e53680808080808080a0ed7cf8b4b1d9aff50a30a59e8f833ff8ef3a02d2545f591e18cba63eeee59fc08080808080808080"));
       encodedProof.add(HexConverter.hexStringToByteArray("f9066830b90664f90661018307f667b9010000000002000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000008000000000000000000000200000000000080000000002000008000000000000000100100000000000000000000000000000000000040000000000000000000000000000000000000010000000000000000000000000000000000000000000000002000000000000000000000000022000000010000004000000000008000000000000000000000010000000000000200002000000000000000000000000000000000000000000000000000000200210000001000000000000000000000000001000000000000000200000800000f90556f89b948c2e5fc5d651129ce7296847dcfac62c646e4e3df863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa000000000000000000000000070e789d2f5d469ea30e0525dbfdd5515d6ead30da000000000000000000000000081c0094f73123eebd250ab4ee1e8aa6e82a7ca6fa0000000000000000000000000000000000000000000000000000000000000000af89b948c2e5fc5d651129ce7296847dcfac62c646e4e3df863a08c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925a000000000000000000000000070e789d2f5d469ea30e0525dbfdd5515d6ead30da000000000000000000000000081c0094f73123eebd250ab4ee1e8aa6e82a7ca6fa00000000000000000000000000000000000000000000000000000000000000000f9021a94aafc8eeaee8d9c8bd3262cce3d73e56dee3fb776e1a037be353f216cf7e33639101fd610c542e6a0c0109173fa1c1d8b04d34edb7c1bb901e00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000003e6274703a2f2f30786638616163332e69636f6e2f637865613139613764366539613932363736376431643035656561343637323939666534363163306562000000000000000000000000000000000000000000000000000000000000000000f7f8f5b8396274703a2f2f307839372e6273632f307841614663384565614545386439433862443332363243434533443733453536446545334642373736b83e6274703a2f2f30786638616163332e69636f6e2f63786561313961376436653961393236373637643164303565656134363732393966653436316330656288546f6b656e42534800b86ef86c00b869f867b3307837306537383964326635643436396561333065303532356462666464353531356436656164333064000000000000000000aa637861616462666536346236613465656262623335616464306439663036363335363964626239613138c7c6834554480a00000000000000000000f901fc9430802e869941c6347a904ca034840a30b1d728baf842a050d22373bb84ed1f9eeb581c913e6d45d918c05f8b1d90f0be168f06a4e6994aa000000000000000000000000070e789d2f5d469ea30e0525dbfdd5515d6ead30db901a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000003e6274703a2f2f30786638616163332e69636f6e2f6378616164626665363462366134656562626233356164643064396630363633353639646262396131380000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034554480000000000000000000000000000000000000000000000000000000000"));
       byte[] enc = Trie.verifyProof(root, new byte[]{-128}, encodedProof);
       Receipt receipt = Receipt.fromBytes(enc);
       assertNotNull(receipt);
       //assertEquals(receipt.getLogs().size(), 1);
    }

}